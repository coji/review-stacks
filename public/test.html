<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Send Beacon Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/daisyui@2.42.1/dist/full.css"
      rel="stylesheet"
      type="text/css"
    />
  </head>
  <body class="grid h-screen" style="grid-template-rows: auto 1fr auto">
    <header class="p-2">
      <h1>離脱イベントテスト</h1>
    </header>

    <main class="p-2 bg-base-300">
      <form id="form" class="card bg-base-100 shadow-md">
        <div class="card-body">
          <label class="label">お名前</label>
          <input
            class="input input-bordered w-ful"
            type="text"
            name="name"
            autofocus
          />
          <label class="label">メッセージ</label>
          <input
            class="input input-bordered w-full"
            type="text"
            name="message"
          />
          <p class="p-4">
            お名前とメッセージを入れてからブラウザバック、またはページ最下部リンクから離脱してね！
          </p>
        </div>
      </form>
    </main>

    <footer class="p-2">
      <nav class="text-center">
        <span class="link" onclick="history.back()">戻る</span>
        <a class="link" href="https://www.google.com/">Google に行く</a>
      </nav>
    </footer>

    <script>
      // ページ離脱時に漏れなく beacon を送信する
      window.addEventListener(
        'beforeunload',
        () => {
          const formData = new FormData(document.getElementById('form'))
          formData.append('event', 'unload')
          formData.append('time', new Date())
          formData.append('url', location.href)
          navigator.sendBeacon(
            '/api/beacon',
            JSON.stringify(Object.fromEntries(formData.entries()))
          )
        },
        { passive: true }
      )

      // リンクをクリックしたときに beacon を送信する
      document.querySelectorAll('a').forEach(
        (a) => {
          a.addEventListener('click', (e) => {
            const formData = new FormData(document.getElementById('form'))
            formData.append('event', 'link')
            formData.append('time', new Date())
            formData.append('url', location.href)
            formData.append('href', e.target.href)
            navigator.sendBeacon(
              '/api/beacon',
              JSON.stringify(Object.fromEntries(formData.entries()))
            )
          })
        },
        { passive: true }
      )
    </script>
  </body>
</html>
